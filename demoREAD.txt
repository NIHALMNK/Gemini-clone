import React, { useState } from "react";
import { GoogleGenerativeAI } from "@google/generative-ai";
import { 
  User, 
  Compass, 
  Lightbulb, 
  MessageCircle, 
  Code, 
  Image as ImageIcon, 
  Mic, 
  Send, 
  Sparkles 
} from "lucide-react";

// --- INLINE STYLES (Previously in Main.css) ---
const styles = `
  .main {
    flex: 1;
    min-height: 100vh;
    padding-bottom: 15vh;
    position: relative;
    font-family: Outfit, sans-serif;
    background-color: #fff;
    color: #585858;
  }
  
  .nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px;
    color: #585858;
    font-size: 22px;
  }
  
  .nav img, .nav-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
  }

  .main-container {
    max-width: 900px;
    margin: auto;
  }

  .greet {
    margin: 50px 0px;
    font-size: 56px;
    color: #c4c7c5;
    font-weight: 500;
    padding: 20px;
  }

  .greet span {
    background: -webkit-linear-gradient(16deg, #4b90ff, #ff5546);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 15px;
    padding: 20px;
  }

  .card {
    height: 200px;
    padding: 15px;
    background-color: #f0f4f9;
    border-radius: 10px;
    position: relative;
    cursor: pointer;
    transition: 0.3s;
  }

  .card:hover {
    background-color: #dfe4ea;
  }

  .card p {
    color: #585858;
    font-size: 17px;
  }

  .card-icon {
    width: 35px;
    height: 35px;
    padding: 5px;
    position: absolute;
    background-color: white;
    border-radius: 20px;
    bottom: 10px;
    right: 10px;
  }

  .main-bottom {
    position: absolute;
    bottom: 0;
    width: 100%;
    max-width: 900px;
    padding: 0px 20px;
    margin: auto;
    left: 0;
    right: 0;
  }

  .search-box {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    background-color: #f0f4f9;
    padding: 10px 20px;
    border-radius: 50px;
  }

  .search-box img, .search-box-icon {
    width: 24px;
    cursor: pointer;
    margin-left: 10px;
  }

  .search-box input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    padding: 8px;
    font-size: 18px;
  }

  .bottom-info {
    font-size: 13px;
    margin: 15px auto;
    text-align: center;
    font-weight: 300;
  }

  .result {
    padding: 0px 5%;
    max-height: 70vh;
    overflow-y: scroll;
  }

  .result::-webkit-scrollbar {
    display: none;
  }

  .result-title {
    margin: 40px 0px;
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .result img, .result-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
  }

  .result-data {
    display: flex;
    align-items: start;
    gap: 20px;
  }

  .result-data p {
    font-size: 17px;
    font-weight: 300;
    line-height: 1.8;
  }

  .loader {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .loader hr {
    border-radius: 4px;
    border: none;
    background-color: #f6f7f8;
    background: linear-gradient(to right, #9ed7ff, #ffffff, #9ed7ff);
    background-size: 800px 50px;
    height: 20px;
    animation: loader 3s infinite linear;
  }

  @keyframes loader {
    0% {
      background-position: -800px 0px;
    }
    100% {
      background-position: 800px 0px;
    }
  }
`;

function Main() {
  // --- STATE MANAGEMENT ---
  const [input, setInput] = useState("");              
  const [recentPrompt, setRecentPrompt] = useState("");
  const [showResult, setShowResult] = useState(false); 
  const [loading, setLoading] = useState(false);       
  const [resultData, setResultData] = useState("");    

  // --- API CONFIGURATION ---
  // ⚠️ PASTE YOUR API KEY HERE
  const API_KEY = ""; 

  // --- FUNCTION TO SEND PROMPT TO GEMINI ---
  const onSent = async (prompt) => {
    if (!API_KEY) {
      alert("Please enter your Gemini API Key in the code to use this feature.");
      return;
    }

    setResultData("");
    setLoading(true);
    setShowResult(true);
    
    const finalPrompt = prompt !== undefined ? prompt : input;
    setRecentPrompt(finalPrompt);
    
    try {
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

        const result = await model.generateContent(finalPrompt);
        const response = await result.response;
        const text = response.text();

        // Format Response
        let responseArray = text.split("**");
        let newResponse = "";
        for (let i = 0; i < responseArray.length; i++) {
            if (i === 0 || i % 2 !== 0) {
                newResponse += responseArray[i];
            } else {
                newResponse += "<b>" + responseArray[i] + "</b>";
            }
        }
        let newResponse2 = newResponse.split("*").join("</br>");
        
        setResultData(newResponse2);
        
    } catch (error) {
        console.error("Error fetching from Gemini:", error);
        setResultData("Error: Something went wrong. Please check your API key and try again.");
    } finally {
        setLoading(false);
        setInput(""); 
    }
  };

  return (
    <div className="main">
      {/* Inject Styles */}
      <style>{styles}</style>

      <div className="nav">
        <p>Gemini</p>
        <div className="bg-orange-500 rounded-full p-2">
            <User className="text-white w-6 h-6" />
        </div>
      </div>

      <div className="main-container">
        
        {!showResult ? (
          <>
            <div className="greet">
              <p>
                <span>Hello, Dev.</span>
              </p>
              <p>How can I help you today?</p>
            </div>
            
            <div className="cards">
              <div className="card" onClick={() => onSent("Suggest beautiful places to see on an upcoming road trip")}>
                <p>Suggest beautiful places to see on an upcoming road trip</p>
                <Compass className="card-icon text-gray-500" />
              </div>
              <div className="card" onClick={() => onSent("Briefly summarize this concept: urban planning")}>
                <p>Briefly summarize this concept: urban planning</p>
                <Lightbulb className="card-icon text-yellow-500" />
              </div>
              <div className="card" onClick={() => onSent("Brainstorm team bonding activities for our work retreat")}>
                <p>Brainstorm team bonding activities for our work retreat</p>
                <MessageCircle className="card-icon text-blue-500" />
              </div>
              <div className="card" onClick={() => onSent("Improve the readability of the following code")}>
                <p>Improve the readability of the following code</p>
                <Code className="card-icon text-red-400" />
              </div>
            </div>
          </>
        ) : (
          <div className="result">
            <div className="result-title">
              <div className="bg-orange-500 rounded-full p-1.5 w-10 h-10 flex items-center justify-center">
                  <User className="text-white w-6 h-6" />
              </div>
              <p>{recentPrompt}</p>
            </div>
            
            <div className="result-data">
              <div className="bg-blue-500 rounded-full p-1.5 min-w-[40px] h-10 flex items-center justify-center mt-[-5px]">
                  <Sparkles className="text-white w-5 h-5" />
              </div>
              {loading ? (
                <div className="loader">
                  <hr />
                  <hr />
                  <hr />
                </div>
              ) : (
                <p dangerouslySetInnerHTML={{ __html: resultData }}></p>
              )}
            </div>
          </div>
        )}

        <div className="main-bottom">
          <div className="search-box">
            <input 
                onChange={(e) => setInput(e.target.value)} 
                value={input} 
                type="text" 
                placeholder="Enter a prompt here"
                onKeyDown={(e) => {
                    if (e.key === 'Enter') onSent();
                }}
            />
            <div className="flex items-center gap-3 text-gray-400">
              <ImageIcon className="w-5 h-5 cursor-pointer hover:text-gray-600" />
              <Mic className="w-5 h-5 cursor-pointer hover:text-gray-600" />
              {input && (
                  <Send 
                    onClick={() => onSent()} 
                    className="w-5 h-5 cursor-pointer text-blue-500 hover:text-blue-600" 
                  />
              )}
            </div>
          </div>
          <p className="bottom-info">
            Gemini may display inaccurate info, including about people, so double-check its responses. Your privacy and Gemini Apps
          </p>
        </div>
      </div>
    </div>
  );
}

export default Main;